# 前后端整合测试指南

**创建时间：** 2025年11月28日  
**项目：** 老友助手小程序

---

## ✅ 整合完成情况

### 已完成的工作

| 项目 | 说明 | 状态 |
|------|------|------|
| **Java后端** | Spring Boot API服务 | ✅ 完成 |
| **前端配置** | API地址配置 | ✅ 完成 |
| **请求封装** | HTTP请求工具类 | ✅ 完成 |
| **API接口** | 缴费接口封装 | ✅ 完成 |
| **页面更新** | 缴费页面连接后端 | ✅ 完成 |
| **CORS配置** | 跨域支持 | ✅ 完成 |

---

## 🚀 启动步骤（按顺序操作）

### 第一步：准备数据库

#### 1.1 启动MySQL
确认MySQL服务已启动：
```bash
# Windows: 在服务管理中启动MySQL
# 或命令行启动
net start MySQL80
```

#### 1.2 创建数据库并初始化
打开MySQL命令行或Navicat，执行：

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS elderly_assistant 
DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE elderly_assistant;

-- 执行初始化脚本
source C:/Users/28614/Desktop/作业/软工/新建文件夹/database/init_database.sql;
```

或者直接在MySQL中执行SQL文件内容。

#### 1.3 插入测试数据（重要！）

为了测试，需要插入一些模拟数据：

```sql
USE elderly_assistant;

-- 插入测试用户
INSERT INTO USER_BASE (user_id, user_name, user_age, phone, dialect_type, avatar_url, create_time, update_time) 
VALUES ('USER_123', '张大爷', 68, 'encrypted_phone', 'zh', 'https://example.com/avatar.jpg', UNIX_TIMESTAMP()*1000, UNIX_TIMESTAMP()*1000);

-- 插入测试缴费项目
INSERT INTO PAYMENT_CONFIG (config_id, user_id, payment_type, account_number, default_amount, status, due_date, bill_month, remark, create_time, update_time, last_pay_time) 
VALUES 
('PAY_ITEM_001', 'USER_123', '电费', '****1234', 126.30, '欠费', '2025-12-05', '2025-11', '2025年11月电费账单', UNIX_TIMESTAMP()*1000, UNIX_TIMESTAMP()*1000, 0),
('PAY_ITEM_002', 'USER_123', '水费', '****5678', 45.60, '欠费', '2025-12-10', '2025-11', '2025年11月水费账单', UNIX_TIMESTAMP()*1000, UNIX_TIMESTAMP()*1000, 0),
('PAY_ITEM_003', 'USER_123', '网费', '****9012', 99.00, '欠费', '2025-12-15', '2025-11', '2025年11月宽带费', UNIX_TIMESTAMP()*1000, UNIX_TIMESTAMP()*1000, 0);

-- 验证数据
SELECT * FROM USER_BASE WHERE user_id = 'USER_123';
SELECT * FROM PAYMENT_CONFIG WHERE user_id = 'USER_123';
```

---

### 第二步：启动Java后端

#### 2.1 配置数据库连接

编辑文件：`java-backend/src/main/resources/application.yml`

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/elderly_assistant
    username: root        # 改成你的MySQL用户名
    password: 123456      # 改成你的MySQL密码
```

#### 2.2 启动后端服务

打开命令行（CMD或PowerShell），执行：

```bash
# 进入后端目录
cd "C:\Users\28614\Desktop\作业\软工\新建文件夹\java-backend"

# 编译项目
mvn clean install

# 启动服务
mvn spring-boot:run
```

#### 2.3 确认启动成功

看到以下输出表示成功：
```
========================================
老友助手后端服务启动成功！
访问地址: http://localhost:8080/api
========================================
```

#### 2.4 测试后端接口

打开浏览器或使用curl测试：

**测试地址：**
```
http://localhost:8080/api/payment/unpaid-items?user_id=USER_123
```

**期望响应：**
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "itemId": "PAY_ITEM_001",
      "userId": "USER_123",
      "itemType": "电费",
      "account": "****1234",
      "amount": 126.30,
      "status": "欠费",
      "dueDate": "2025-12-05",
      "billMonth": "2025-11",
      "remark": "2025年11月电费账单"
    }
  ]
}
```

---

### 第三步：配置并启动前端

#### 3.1 安装微信开发者工具

如果还没有安装，请下载：
https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html

#### 3.2 导入项目

1. 打开微信开发者工具
2. 选择"导入项目"
3. 项目目录选择：`C:\Users\28614\Desktop\作业\软工\新建文件夹\minicode-1`
4. AppID选择"测试号"或使用自己的AppID

#### 3.3 配置不校验合法域名

**重要！** 由于使用localhost，需要关闭域名校验：

1. 点击右上角"详情"
2. 找到"本地设置"
3. 勾选"不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书"

#### 3.4 检查API配置

确认文件 `minicode-1/utils/config.js` 的配置：

```javascript
const DEV_CONFIG = {
  apiBaseUrl: 'http://localhost:8080/api',  // 确认端口是8080
  timeout: 10000,
  useMock: false
};
```

#### 3.5 编译项目

1. 点击"编译"按钮
2. 查看控制台是否有错误
3. 确认项目编译成功

---

### 第四步：测试前后端联调

#### 4.1 进入缴费页面

1. 在模拟器中点击"生活缴费"功能
2. 或者直接在小程序页面列表中找到 `pages/Living_payment/Living_payment`

#### 4.2 观察控制台输出

**成功的情况：**
```
获取缴费项目成功: Array(3)
```

**失败的情况（后端未启动）：**
```
获取缴费项目失败: Error
无法连接服务器，请确认后端已启动
```
此时会显示Mock数据。

#### 4.3 查看数据展示

页面应该显示：
- 电费: ¥126.30（欠费）
- 水费: ¥45.60（欠费）
- 网费: ¥99.00（欠费）

#### 4.4 测试标记已支付功能

1. 点击任意一条缴费项目的"已支付"按钮
2. 确认弹窗
3. 观察是否刷新数据

---

## 🔍 问题排查

### 问题1：前端提示"无法连接服务器"

**原因：** 后端未启动或端口不正确

**解决：**
1. 确认后端已启动（查看控制台是否有"启动成功"提示）
2. 确认端口是8080：在浏览器访问 http://localhost:8080/api/payment/unpaid-items?user_id=USER_123
3. 检查防火墙是否阻止了8080端口

### 问题2：后端启动失败"数据库连接失败"

**原因：** MySQL未启动或配置错误

**解决：**
1. 确认MySQL服务已启动
2. 检查`application.yml`中的用户名密码
3. 尝试用MySQL客户端连接测试

### 问题3：前端显示空数据

**原因：** 数据库中没有测试数据

**解决：**
执行上面的SQL插入语句，确保`PAYMENT_CONFIG`表中有数据

### 问题4：跨域错误（CORS）

**原因：** CORS配置未生效

**解决：**
确认`CorsConfig.java`文件已创建，并重启后端服务

### 问题5：请求超时

**原因：** 网络或后端响应慢

**解决：**
1. 检查后端日志是否有异常
2. 增加`config.js`中的`timeout`值
3. 检查数据库查询性能

---

## 📊 测试检查清单

### 后端测试

- [ ] MySQL服务已启动
- [ ] 数据库`elderly_assistant`已创建
- [ ] 测试数据已插入
- [ ] 后端服务启动成功（看到启动提示）
- [ ] 浏览器可以访问API接口
- [ ] API返回正确的JSON格式

### 前端测试

- [ ] 微信开发者工具已安装
- [ ] 项目导入成功
- [ ] 关闭域名校验
- [ ] API配置正确（localhost:8080）
- [ ] 项目编译无错误
- [ ] 控制台无报错

### 联调测试

- [ ] 前端可以获取缴费列表
- [ ] 数据显示正确
- [ ] 可以标记已支付
- [ ] 操作后数据刷新
- [ ] 错误提示友好（后端关闭时显示Mock数据）

---

## 🎯 完整的测试命令

### 一键测试脚本（Windows PowerShell）

将以下内容保存为`test-backend.ps1`：

```powershell
# 测试后端是否启动
Write-Host "测试后端连接..." -ForegroundColor Yellow

try {
    $response = Invoke-RestMethod -Uri "http://localhost:8080/api/payment/unpaid-items?user_id=USER_123" -Method Get
    
    if ($response.code -eq 0) {
        Write-Host "✅ 后端连接成功！" -ForegroundColor Green
        Write-Host "📊 获取到 $($response.data.Count) 条缴费记录" -ForegroundColor Cyan
        $response.data | ForEach-Object {
            Write-Host "  - $($_.itemType): ¥$($_.amount) ($($_.status))" -ForegroundColor White
        }
    } else {
        Write-Host "❌ 后端返回错误: $($response.message)" -ForegroundColor Red
    }
} catch {
    Write-Host "❌ 无法连接后端！请确认：" -ForegroundColor Red
    Write-Host "   1. MySQL服务已启动" -ForegroundColor Yellow
    Write-Host "   2. Java后端已启动" -ForegroundColor Yellow
    Write-Host "   3. 端口8080未被占用" -ForegroundColor Yellow
}
```

运行：
```powershell
powershell -ExecutionPolicy Bypass -File test-backend.ps1
```

---

## 📱 前端测试截图检查点

### 启动时

1. 控制台应显示："缴费页面加载成功"
2. 控制台应显示："获取缴费项目成功"
3. 页面应显示缴费列表

### 操作时

1. 点击"已支付"应弹出确认框
2. 确认后应显示"标记成功"
3. 列表应自动刷新

### 异常时

1. 后端关闭时应显示"无法连接服务器"
2. 自动降级到Mock数据
3. Mock数据应正常显示

---

## 🎉 测试成功标志

当你看到以下情况，说明前后端整合成功：

✅ 后端控制台显示启动成功  
✅ 浏览器可以访问API接口并看到数据  
✅ 微信开发者工具编译无错误  
✅ 缴费页面显示真实数据（不是Mock数据）  
✅ 控制台显示"获取缴费项目成功"  
✅ 可以正常标记已支付并刷新  

---

## 📞 需要帮助？

如果遇到问题，请提供以下信息：

1. **后端启动日志**（最后50行）
2. **前端控制台错误**（完整错误信息）
3. **数据库查询结果**（SELECT * FROM PAYMENT_CONFIG）
4. **API测试结果**（浏览器访问API的响应）

---

**祝测试顺利！** 🎊
