# 🎤 语音识别功能测试指南

## ✅ 已完成的工作

### 后端（Java）
1. ✅ 创建了 `VoiceService.java` - 百度语音识别服务
2. ✅ 创建了 `VoiceController.java` - 语音识别API接口 (`/api/voice/recognize`)
3. ✅ 集成百度语音 API，自动获取 access_token

### 前端（小程序）
1. ✅ 创建了 `utils/voice.js` - 通用语音录音工具
2. ✅ 在首页 `pages/index/index.js` 添加了录音功能
3. ✅ 在缴费页 `pages/Living_payment/Living_payment.js` 添加了录音功能

---

## 🚀 启动步骤

### 步骤1：重新编译后端（包含语音功能）

打开CMD或PowerShell，执行：

```bash
cd "C:\Users\28614\Desktop\作业\软工\old friend\java-backend"

# 清理旧文件
mvn clean

# 重新打包
mvn package

# 启动后端
java -jar target\assistant-backend-1.0.0.jar
```

**等待看到：**
```
========================================
老友助手后端服务启动成功！
访问地址: http://localhost:8081/api
========================================
```

### 步骤2：在WXML中绑定事件（重要）

#### 首页语音按钮

打开 `minicode-1/pages/index/index.wxml`，找到"点击说话"按钮，修改为：

```xml
<!-- 原来可能是这样 -->
<view class="voice-button" bindtap="onVoiceInputTap">
  点击说话
</view>

<!-- 改成长按触发 -->
<view class="voice-button" 
      bindtouchstart="onVoiceInputStart" 
      bindtouchend="onVoiceInputEnd"
      class="{{isRecording ? 'recording' : ''}}">
  {{isRecording ? '录音中...' : '点击说话'}}
</view>
```

#### 缴费页语音按钮（如果有）

打开 `minicode-1/pages/Living_payment/Living_payment.wxml`，找到语音按钮并添加：

```xml
<button bindtouchstart="onVoiceStart" 
        bindtouchend="onVoiceEnd"
        class="voice-btn {{isRecording ? 'recording' : ''}}">
  {{isRecording ? '录音中...' : '语音缴费'}}
</button>
```

### 步骤3：微信开发者工具设置

1. 打开微信开发者工具
2. 点击右上角"详情" → "本地设置"
3. 确保勾选了：
   - ✅ 不校验合法域名
   - ✅ 不校验 TLS 版本以及 HTTPS 证书
4. 点击"编译"

### 步骤4：添加录音权限

打开 `minicode-1/app.json`，添加录音权限：

```json
{
  "pages": [...],
  "permission": {
    "scope.record": {
      "desc": "需要使用您的麦克风进行语音识别"
    }
  }
}
```

---

## 🎯 测试语音功能

### 测试A：首页语音识别

1. 在小程序模拟器中打开首页
2. **长按**底部的"点击说话"按钮
3. 对着麦克风说话（例如："帮我交电费"）
4. **松开**按钮
5. 等待识别结果（会弹出对话框显示识别的文字）

**预期结果：**
- 长按时显示"录音中..."
- 松开后出现"识别中..."加载提示
- 弹窗显示识别结果："帮我交电费"

### 测试B：缴费页语音识别

1. 点击进入"生活缴费"页面
2. 找到语音按钮
3. **长按**语音按钮
4. 说话（例如："查询水费"）
5. **松开**按钮
6. 查看识别结果

---

## 📝 控制台日志验证

### 小程序控制台应该看到：

```
开始录音
停止录音
语音识别响应: {statusCode: 200, data: "..."}
识别结果: 帮我交电费
```

### 后端控制台应该看到：

```
收到语音识别请求，文件名: xxx.mp3, 大小: 12345 bytes
调用百度语音识别API，文件大小: 12345 bytes
百度语音识别响应: {"err_no":0,"result":["帮我交电费"]}
语音识别成功: 帮我交电费
```

---

## ❌ 常见问题排查

### 问题1：点击按钮没反应

**原因：** WXML中没有绑定 `bindtouchstart` 和 `bindtouchend` 事件  
**解决：** 按照步骤2修改 WXML 文件

### 问题2：提示"没有录音文件"

**原因：** 录音时间太短或录音失败  
**解决：** 
- 确保**长按**按钮至少1秒
- 检查是否授权了麦克风权限

### 问题3：识别失败"无法连接服务器"

**原因：** 后端没启动或端口不对  
**解决：** 
- 确认后端在 8081 端口运行
- 检查 `utils/config.js` 里的 `apiBaseUrl` 是 `http://localhost:8081/api`

### 问题4：后端报错"access_token获取失败"

**原因：** 百度API Key配置错误  
**解决：** 
- 检查 `application.yml` 里的 `api-key` 和 `secret-key`
- 确认百度语音服务是否正常（可能需要在百度AI开放平台重新申请）

### 问题5：识别结果不准确

**原因：** 录音质量、环境噪音  
**解决：** 
- 靠近麦克风说话
- 说话清晰、语速适中
- 减少环境噪音

---

## 🔧 调试技巧

### 1. 测试百度API是否可用

在浏览器中访问（需要替换你的真实key）：

```
https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=你的API_KEY&client_secret=你的SECRET_KEY
```

应该返回：
```json
{
  "access_token": "24.xxx...",
  "expires_in": 2592000
}
```

### 2. 查看录音文件

在 `voice.js` 的 `stopRecord` 回调中添加：

```javascript
recorderManager.onStop((res) => {
  console.log('录音结束', res);
  console.log('录音时长：', res.duration, 'ms');
  console.log('文件大小：', res.fileSize, 'bytes');
  tempAudioPath = res.tempFilePath;
});
```

### 3. 后端日志详细模式

修改 `application.yml`：

```yaml
logging:
  level:
    com.elderly: debug
    com.baomidou.mybatisplus: debug
```

重启后端，会看到更详细的日志。

---

## ✅ 完整测试检查清单

- [ ] 后端在 8081 端口成功启动
- [ ] 小程序已关闭域名校验
- [ ] 小程序已添加录音权限配置
- [ ] WXML按钮已绑定 `bindtouchstart` 和 `bindtouchend`
- [ ] 长按按钮能触发录音（显示"录音中"）
- [ ] 松开按钮后出现"识别中"提示
- [ ] 识别结果正确弹出
- [ ] 控制台日志正常（前端+后端）
- [ ] 百度API Key配置正确

---

## 📞 下一步计划

当语音识别功能稳定后，可以继续实现：

1. **智能缴费指令解析**
   - 识别文字中的"电费/水费/燃气费"
   - 识别金额
   - 自动调用 `paymentApi.voicePay()`

2. **语音反馈**
   - 识别成功后语音播报结果
   - 使用 `wx.createInnerAudioContext()` 播放提示音

3. **历史记录**
   - 保存语音识别历史
   - 方便查看过往指令

---

**开始测试吧！遇到问题随时告诉我。** 🎉
