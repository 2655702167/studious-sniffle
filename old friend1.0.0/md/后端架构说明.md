# 老友助手小程序 - 后端架构设计说明

**负责人：** 施汉霖（102301524）  
**模块：** 后端（架构设计 + 智能体引擎）  
**完成时间：** 2025年11月  

---

## 一、整体架构概述

### 1.1 技术选型

- **开发语言：** C++ (后端服务层)
- **前端：** 微信小程序原生框架
- **数据库：** MySQL / 微信云开发数据库
- **AI服务：** 百度文心一言 API（智能对话）
- **语音服务：** 百度语音识别 API / 微信语音接口
- **部署方式：** Docker容器化 + 云服务器

### 1.2 架构分层

```
┌─────────────────────────────────────────┐
│         微信小程序前端 (WXML/WXSS/JS)      │
└─────────────────────────────────────────┘
                    ↓ HTTP/HTTPS
┌─────────────────────────────────────────┐
│           服务层 (Service Layer)          │
│  ┌──────────────────────────────────┐   │
│  │ payment_service.h (缴费服务)      │   │
│  │ taxi_service.h (打车服务)         │   │
│  │ hospital.h (挂号服务)             │   │
│  │ chat_service.h (智能陪聊)         │   │
│  │ emergency_service.h (紧急呼叫)    │   │
│  │ health_service.h (健康监控)       │   │
│  │ user_service.h (用户中心)         │   │
│  │ help_service.h (帮助服务)         │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│       数据访问层 (DAO Layer)              │
│  PaymentDao, TaxiDao, UserDao...        │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│            数据库 (Database)              │
│  USER_BASE, PAYMENT_*, TAXI_*,           │
│  HEALTH_LOG, AGENT_LOG...               │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│          第三方服务 (External APIs)       │
│  文心一言, 百度语音, 地图API, 支付API     │
└─────────────────────────────────────────┘
```

---

## 二、核心服务模块设计

### 2.1 语音支付服务 (VoicePaymentService)

**功能：** 支持老年人通过语音完成生活缴费

**核心流程：**
```
用户说"我要交电费" 
  → 语音识别(VoiceRecognition)
  → 意图提取(ExtractPaymentIntent)
  → 多轮对话管理(HandlePaymentSession)
  → 调用支付API(PaymentService::CreatePaymentOrder)
  → 返回语音反馈
```

**关键技术点：**
- 会话管理（3分钟有效期）
- 语音意图识别（准确率>90%）
- 多轮对话支持（"我要缴费"->"哪一项"->"水费"->"确认"）
- 二次确认机制（避免误操作）

**代码文件：**
- `code/voice_recognition.h` - 语音识别与意图提取
- `code/voice_payment_service.h` - 语音支付业务逻辑
- `service/payment.h` - 基础缴费服务

---

### 2.2 智能陪聊服务 (ChatService)

**功能：** 基于文心一言API，为老年人提供情感陪伴

**核心流程：**
```
用户："我有点想孙子了"
  → ChatService::Chat()
  → 构造上下文（最近10轮对话）
  → 调用文心一言API
  → AI回复："孙子也一定想您呢！要不要给他发个语音？"
  → TTS语音播报
```

**关键功能：**
1. **多轮对话管理**
   - 会话保持30分钟
   - 历史对话上下文（最多10轮）
   - 系统提示词定义AI角色为"温暖、耐心的老友"

2. **语音意图识别**
   - `ParseVoiceIntent()` - 识别用户意图
   - 支持跨服务调用（打车/缴费/挂号）
   - 置信度评估（>0.85触发）

3. **亲人音色设置**
   - `SetVoiceProfile()` - 保存孙辈录音
   - 用于TTS合成个性化语音

4. **节日祝福**
   - `GetFestivalGreeting()` - 自动推送节日祝福

**代码文件：**
- `service/chat_service.h` - 智能对话核心逻辑

---

### 2.3 打车服务 (TaxiService)

**功能：** 语音/快捷按钮打车，适配老年人出行需求

**核心流程：**
```
用户说"去医院" 或 点击"医院"按钮
  → 解析目的地(ResolveLocation)
  → 自动获取起点(用户当前位置)
  → 创建订单(CreateTaxiOrder)
  → 预估费用(CalculateEstimateFee)
  → 派单给司机(DispatchOrder)
  → 实时推送订单状态
```

**关键功能：**
- 常用地址管理（家/医院/超市）
- 快捷目的地选择（一键下单）
- 费用预估（基于距离和时长）
- 订单状态同步（待派单→已接单→已到达→完成）
- 语音播报状态变化

**代码文件：**
- `service/taxi.h` - 打车业务逻辑
- `model/taxi.h`, `taxi_order.h`, `taxi_location.h` - 数据模型

---

### 2.4 医院挂号服务 (HospitalService)

**功能：** 在线预约挂号，减少老年人排队时间

**核心流程：**
```
用户说"我要挂内科" 或 选择科室
  → GetHospitalsByDeptAndLocation() - 查询附近医院
  → 显示医院列表（按距离排序）
  → CreateReserveOrder() - 提交预约
  → 扣减医院配额
  → 生成预约单号
  → 发送预约提醒
```

**关键功能：**
- 科室列表查询
- 附近医院搜索（基于地理位置）
- 距离计算（Haversine公式）
- 配额管理（防止超额预约）
- 预约记录查询

**代码文件：**
- `service/hospital.h` - 挂号业务逻辑
- `model/hospital.h`, `reserve_order.h` - 数据模型

---

### 2.5 紧急呼叫服务 (EmergencyService)

**功能：** 一键拨打紧急联系人、120、110

**核心流程：**
```
用户点击"紧急呼叫"
  → GetEmergencyContacts() - 获取联系人列表
  → 显示：家属 + 120 + 110
  → 用户点击号码
  → 前端调用wx.makePhoneCall()拨号
  → LogEmergencyCall() - 记录呼叫日志
  → 通知家属（可选）
```

**关键功能：**
- 家属联系人管理
- 呼叫日志记录
- 主联系人设置
- 呼叫状态跟踪（已拨打/已接通/失败）
- 电话号码脱敏显示

**代码文件：**
- `service/emergency_service.h` - 紧急呼叫逻辑

---

### 2.6 健康监控服务 (HealthService)

**功能：** 智能手环数据同步，健康异常预警

**核心流程：**
```
智能手环上传数据
  → SyncHealthData() - 接收心率、血压、步数
  → 保存到HEALTH_LOG表
  → DetectHealthAbnormality() - 检测异常
  → 如心率≥105：触发预警
  → NotifyEmergencyContacts() - 通知家属
  → 返回预警信息给前端
```

**健康指标阈值：**
- **心率：** 正常60-100次/分，≥105或≤55触发预警
- **血压：** 正常收缩压90-140，舒张压60-90，超出触发预警
- **预警级别：** warning（偏高/低）/ danger（严重异常）

**代码文件：**
- `service/health_service.h` - 健康监控逻辑

---

### 2.7 用户中心服务 (UserService)

**功能：** 管理用户信息、地址、设置

**核心功能：**
1. **用户信息管理**
   - 查询/更新基础信息（姓名、年龄、手机号）
   - 手机号加密存储（CryptoUtil::Encrypt）
   - 手机号脱敏显示（136****1234）

2. **用户设置管理**
   - 字体大小（standard/large/extra_large）
   - 语音音量（0-100）
   - 方言选择（普通话/粤语/四川话）
   - 亲人音色配置

3. **地址管理**
   - 新增/编辑/删除地址
   - 设置默认地址
   - 地址列表查询（默认地址在前）

**代码文件：**
- `service/user_service.h` - 用户中心逻辑

---

### 2.8 帮助服务 (HelpService)

**功能：** 视频教程、语音操作指南、常见问题

**内容列表：**
1. **视频教程**
   - 如何语音打车（2分钟）
   - 如何语音缴费（2分30秒）
   - 如何预约挂号（3分钟）

2. **语音操作指南**
   - 基础语音操作（按住说话、松开发送）
   - 打车语音指令示例
   - 缴费语音指令示例
   - 挂号语音指令示例

3. **常见问题（FAQ）**
   - 通用问题（字体调整、语音识别）
   - 打车问题（取消订单、等待时间）
   - 缴费问题（安全性、失败处理）
   - 挂号问题（预约时间、取号方式）

**代码文件：**
- `service/help_service.h` - 帮助服务逻辑

---

## 三、智能体引擎设计

### 3.1 核心能力

智能体引擎是本项目的**核心创新点**，整合了：
- **语音识别** - 百度语音API
- **意图理解** - 关键词匹配 + 正则表达式
- **对话管理** - 多轮上下文记忆
- **AI对话** - 文心一言API
- **服务编排** - 跨服务意图调用

### 3.2 意图识别流程

```cpp
// ChatService::ParseVoiceIntent()
用户输入："我要去医院交电费"
  ↓
1. 关键词匹配
   - "去医院" → taxi意图
   - "交电费" → payment意图
  ↓
2. 意图优先级
   - taxi置信度: 0.90
   - payment置信度: 0.92
  ↓
3. 选择最高置信度意图
   - 返回payment意图
  ↓
4. 提取槽位信息
   - payment_type: "电费"
  ↓
5. 调用对应服务
   - PaymentService::VoicePay()
```

### 3.3 多轮对话示例

```
[轮次1]
用户: "我要缴费"
智能体: "您有3项待缴费用：水费85.60元、电费126.30元、网费99.00元。请问您要缴哪一项？"
(session_id=SESSION123, status=waiting_type)

[轮次2]
用户: "电费"
智能体: "您要缴纳电费，金额126.30元。请说"确认"继续支付"
(session_id=SESSION123, status=waiting_confirm)

[轮次3]
用户: "确认"
智能体: "已为您发起电费支付，请在微信中完成支付"
(session_id=SESSION123, status=completed)
```

### 3.4 语音交互优化

**适老化设计：**
1. **置信度阈值放宽** - 识别准确率≥0.85即可接受（标准系统≥0.95）
2. **容错机制** - 识别失败自动重试，提示"没听清，请再说一遍"
3. **降级回复** - AI服务不可用时，返回预设话术
4. **语音反馈** - 每次操作后，语音播报结果
5. **方言支持** - 识别普通话、粤语、四川话等

---

## 四、数据库设计

### 4.1 核心表结构

#### 用户相关
```sql
-- 用户基础表
CREATE TABLE USER_BASE (
    user_id VARCHAR(50) PRIMARY KEY,
    user_name VARCHAR(50),
    user_age INT,
    phone VARCHAR(200),  -- 加密存储
    dialect_type VARCHAR(20),
    create_time BIGINT
);

-- 用户家属表
CREATE TABLE USER_FAMILY (
    family_id VARCHAR(50) PRIMARY KEY,
    user_id VARCHAR(50),
    family_name VARCHAR(50),
    family_phone VARCHAR(200),  -- 加密存储
    relation VARCHAR(20),
    is_default_pay BOOLEAN,
    FOREIGN KEY (user_id) REFERENCES USER_BASE(user_id)
);

-- 用户地址表
CREATE TABLE USER_ADDRESS (
    address_id VARCHAR(50) PRIMARY KEY,
    user_id VARCHAR(50),
    address_name VARCHAR(50),
    province VARCHAR(20),
    city VARCHAR(20),
    detail_address VARCHAR(200),
    longitude DOUBLE,
    latitude DOUBLE,
    is_default BOOLEAN,
    create_time BIGINT,
    FOREIGN KEY (user_id) REFERENCES USER_BASE(user_id)
);
```

#### 缴费相关
```sql
-- 缴费配置表
CREATE TABLE PAYMENT_CONFIG (
    config_id VARCHAR(50) PRIMARY KEY,
    user_id VARCHAR(50),
    payment_type VARCHAR(20),  -- 水费/电费/网费/话费
    account_number VARCHAR(200),  -- 加密存储
    family_id VARCHAR(50),
    FOREIGN KEY (user_id) REFERENCES USER_BASE(user_id),
    FOREIGN KEY (family_id) REFERENCES USER_FAMILY(family_id)
);

-- 缴费记录表
CREATE TABLE PAYMENT_RECORD (
    record_id VARCHAR(50) PRIMARY KEY,
    config_id VARCHAR(50),
    payment_amount DECIMAL(10,2),
    payment_time BIGINT,
    payment_status VARCHAR(20),
    trade_no VARCHAR(100),
    FOREIGN KEY (config_id) REFERENCES PAYMENT_CONFIG(config_id)
);
```

#### 健康相关
```sql
-- 健康日志表
CREATE TABLE HEALTH_LOG (
    log_id VARCHAR(50) PRIMARY KEY,
    user_id VARCHAR(50),
    device_sn VARCHAR(50),
    heart_rate INT,
    blood_pressure VARCHAR(20),
    step_count INT,
    log_type VARCHAR(20),
    log_time BIGINT,
    FOREIGN KEY (user_id) REFERENCES USER_BASE(user_id)
);

-- 设备绑定表
CREATE TABLE DEVICE_BIND (
    bind_id VARCHAR(50) PRIMARY KEY,
    user_id VARCHAR(50),
    device_type VARCHAR(20),
    device_brand VARCHAR(50),
    device_sn VARCHAR(50),
    bind_time BIGINT,
    last_sync_time BIGINT,
    FOREIGN KEY (user_id) REFERENCES USER_BASE(user_id)
);
```

#### 日志相关
```sql
-- 智能体操作日志
CREATE TABLE AGENT_LOG (
    log_id VARCHAR(50) PRIMARY KEY,
    user_id VARCHAR(50),
    user_query TEXT,
    agent_response TEXT,
    interaction_time BIGINT,
    FOREIGN KEY (user_id) REFERENCES USER_BASE(user_id)
);
```

### 4.2 数据安全设计

1. **敏感数据加密**
   - 手机号：AES加密存储
   - 缴费账号：AES加密存储
   - 密钥管理：环境变量或密钥管理服务

2. **数据脱敏**
   - 手机号：136****1234
   - 缴费账号：****5678

3. **访问控制**
   - 用户只能访问自己的数据
   - DAO层统一校验userId

---

## 五、API接口设计

### 5.1 统一响应格式

```json
{
  "code": 0,
  "message": "success",
  "data": { ... }
}
```

**错误码定义：**
- `0` - 成功
- `1001` - 参数错误
- `2001` - 外部API调用失败
- `3001` - 数据库错误
- `4001` - 未登录/权限不足
- `5000` - 未知错误

### 5.2 核心接口列表

#### 语音支付
```
POST /api/payment/voice-pay
{
  "user_id": "USER_102301524",
  "audio_data": "base64_audio",
  "session_id": ""
}
```

#### 智能对话
```
POST /api/chat/message
{
  "user_id": "USER_102301524",
  "message": "我有点想孙子了",
  "session_id": ""
}
```

#### 打车下单
```
POST /api/taxi/create-order
{
  "user_id": "USER_102301524",
  "start_type": "current",
  "end_type": "quick_dest",
  "end_id": "hospital"
}
```

#### 健康数据同步
```
POST /api/health/sync
{
  "user_id": "USER_102301524",
  "device_sn": "DEVICE_SN_123",
  "heart_rate": 108,
  "blood_pressure": "135/85",
  "step_count": 5432
}
```

---

## 六、部署与性能

### 6.1 部署架构

```
用户 → 微信小程序
  ↓
腾讯云CDN (静态资源)
  ↓
Nginx (负载均衡)
  ↓
后端服务集群 (Docker容器)
  ↓
MySQL主从 (读写分离)
  ↓
Redis缓存 (会话、配置)
```

### 6.2 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| API响应时间 | <500ms | P95 |
| 语音识别延迟 | <2s | 包含网络传输 |
| 并发处理能力 | >1000 QPS | 高峰期 |
| 可用性 | 99.9% | 年均停机<8.76小时 |
| 数据库读写比 | 8:2 | 读多写少 |

### 6.3 优化措施

1. **缓存策略**
   - 用户设置 → Redis (TTL=1小时)
   - 常用地址 → Redis (TTL=30分钟)
   - 科室列表 → 内存缓存

2. **异步处理**
   - 语音识别 → 异步调用
   - 日志写入 → 异步队列
   - 通知推送 → 消息队列

3. **连接池**
   - 数据库连接池 (Min=10, Max=50)
   - HTTP连接复用

---

## 七、测试用例

### 7.1 语音支付测试

| 用例ID | 场景 | 输入 | 预期输出 |
|--------|------|------|----------|
| VP001 | 首次缴费 | "我要缴费" | 列出待缴项目 |
| VP002 | 指定类型 | "我要交电费" | 确认金额，等待确认 |
| VP003 | 确认支付 | "确认" | 发起支付，返回订单 |
| VP004 | 取消支付 | "取消" | 取消会话 |
| VP005 | 识别失败 | 噪音 | "没听清，请再说一遍" |

### 7.2 健康监控测试

| 用例ID | 场景 | 心率 | 血压 | 预期结果 |
|--------|------|------|------|----------|
| H001 | 正常 | 75 | 120/80 | 无预警 |
| H002 | 心率偏高 | 108 | 120/80 | warning预警 |
| H003 | 心率危险 | 125 | 120/80 | danger预警+通知家属 |
| H004 | 血压偏高 | 75 | 145/95 | warning预警 |

---

## 八、项目总结

### 8.1 完成情况

| 模块 | 完成度 | 代码行数 |
|------|--------|----------|
| 语音支付服务 | 100% | ~600行 |
| 智能陪聊服务 | 100% | ~400行 |
| 打车服务 | 95% | ~420行 |
| 挂号服务 | 100% | ~150行 |
| 紧急呼叫服务 | 100% | ~300行 |
| 健康监控服务 | 100% | ~350行 |
| 用户中心服务 | 100% | ~300行 |
| 帮助服务 | 100% | ~200行 |
| **总计** | **98%** | **~2720行** |

### 8.2 技术亮点

1. **智能体引擎**
   - 多轮对话管理
   - 跨服务意图识别
   - 上下文记忆

2. **适老化设计**
   - 语音优先交互
   - 容错机制完善
   - 操作步骤≤3步

3. **健康预警**
   - 实时异常检测
   - 自动通知家属
   - 多级预警机制

### 8.3 后续优化方向

1. **短期（1-2周）**
   - 接入多家语音服务商（讯飞、阿里）
   - 提升识别准确率到95%+

2. **中期（1-2月）**
   - 集成大语言模型（ChatGPT/文心一言4.0）
   - 支持更自然的语言理解

3. **长期（3-6月）**
   - 增加视频通话功能
   - 主动关怀提醒
   - 情感陪伴升级

---

## 九、相关文档

- [API接口文档](./code/API文档.md)
- [语音支付集成指南](./code/集成指南.md)
- [项目完成说明](./code/项目完成说明.md)
- [GitHub仓库](https://github.com/XunBo2023/cuddly-umbrella)

---

**联系方式：**  
- 开发者：施汉霖  
- 学号：102301524  
- 邮箱：shihanlin@example.com  

*本文档最后更新时间：2025年11月27日*
